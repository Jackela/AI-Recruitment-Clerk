# Ralph Progress Log
Started: 2026-02-04
---

## Codebase Patterns
- E2E tests using `MongooseModule.forRoot()` need explicit mongoose connection cleanup in `afterAll`
- `WriteWrap` requests in open-handle warnings are benign (async console writes) - filter them in `isStandardIoHandle`
- When fixing E2E test teardown, close mongoose connection before `app.close()` to prevent pending operations
- Negative test error messages can be gated in `jest.setup.ts` using `ignoredConsoleErrorPatterns`
- Pattern for gating errors: use prefix match like `'Error recording usage:'` to cover variations

## 2026-02-04 - US-001
- Created `docs/TECH_DEBT_REGISTER.md` with 20 technical debt items
- Each item includes impact level, owner, description, and suggested fix
- Items categorized by priority: 6 High, 12 Medium, 2 Low
- Typecheck passes
- Committed: feat: US-001 - Create tech-debt register

**Learnings for future iterations:**
- The codebase has significant technical debt around TypeScript `any` types (164+ files)
- Large files over 500 lines are widespread, particularly `mobile-dashboard.component.ts` (~1208 lines)
- Inconsistent error handling across 239+ files
- Domain model duplication between libs/shared-dtos and domain libraries
- TODO comments scattered across 97+ files should be tracked as tickets
- Hard-coded configuration values in 190+ files need centralization via libs/configuration
- Logging patterns are inconsistent (console.log vs structured logging)

---

## 2026-02-04 - US-002
- Identified top 2 sources of open-handle warnings:
  1. `WriteWrap` requests (benign async console writes)
  2. Mongoose connections not explicitly closed in E2E tests
- Fixed `jest.setup.ts` to filter WriteWrap in `isStandardIoHandle`
- Added mongoose connection cleanup to `comprehensive-api-integration.e2e.spec.ts`
- Added mongoose connection cleanup to `semantic-cache.e2e.spec.ts`
- Tests now pass without open-handle warnings
- Typecheck passes
- Committed: feat: US-002 - Eliminate jest open-handle warnings

**Learnings for future iterations:**
- NestJS `app.close()` does NOT automatically close Mongoose connections
- E2E tests using `MongooseModule.forRoot()` must explicitly close connections
- `WriteWrap` is a Node.js internal for async stream writes (console/stdout) - not a real leak
- Use `JEST_DEBUG_HANDLES=true` to debug handle types

---

## 2026-02-04 - US-003
- Identified top 2 sources of noisy console.error:
  1. `usage-limit.service.spec.ts` - DB error messages from negative tests
  2. `parsing.service.spec.ts` - Circuit breaker messages from negative tests
- Added error patterns to `ignoredConsoleErrorPatterns` in jest.setup.ts:
  - `'Error recording usage:'`
  - `'Error adding bonus quota:'`
  - `'Error getting usage statistics:'`
  - `'Error analyzing usage patterns:'`
  - `'Error getting high risk IPs:'`
  - `'Circuit breaker triggered for handleResumeSubmitted:'`
- Both test suites now pass without noisy console errors
- Test assertions remain intact - only gating expected error messages
- Typecheck passes
- Committed: feat: US-003 - Reduce noisy test console errors

**Learnings for future iterations:**
- Use prefix-based pattern matching for error gating (e.g., `'Error recording usage:'` covers all DB errors)
- Only gate errors that are expected from negative tests - don't hide real failures
- Test each targeted suite individually after adding patterns

