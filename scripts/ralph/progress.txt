# Ralph Progress Log
Started: 2026-02-04
---

## Codebase Patterns
- Use `libs/infrastructure-shared/src/pipes/` for shared NestJS pipes
- Export new utilities from both their folder index and the main lib index
- Use `InternalDtoValidationPipeOptions` pattern to avoid Required<> type issues with optional fields
- Microservices: Register global pipes via APP_PIPE provider token in app.module.ts
- HTTP Gateways: Register global pipes via app.useGlobalPipes() in main.ts

## [2026-02-04] - US-001
- Introduced shared DTO validation pipe in libs/infrastructure-shared
- Created `DtoValidationPipe` class using class-validator and class-transformer
- Added factory function `createDtoValidationPipe` for convenient instantiation
- Exported from infrastructure-shared index for cross-service usage
- Files changed:
  - `libs/infrastructure-shared/src/pipes/dto-validation.pipe.ts` (new)
  - `libs/infrastructure-shared/src/pipes/index.ts` (new)
  - `libs/infrastructure-shared/src/index.ts` (updated)
- **Learnings for future iterations:**
  - Pattern: When creating options interfaces, separate internal required options from public optional options to avoid TypeScript Required<> type issues
  - The app-gateway already has a `CustomValidationPipe` that can be migrated to the shared pipe in future stories (US-002)
  - Typecheck with tsconfig.ci.json is the project's verification standard
---
## [2026-02-04] - US-002
- Replaced NestJS built-in ValidationPipe with shared DtoValidationPipe in app-gateway
- Updated imports in main.ts to use createDtoValidationPipe from infrastructure-shared
- Configured pipe with whitelist=true, transform=true, forbidNonWhitelisted=true
- Files changed:
  - `apps/app-gateway/src/main.ts` (updated)
- **Learnings for future iterations:**
  - app-gateway was using NestJS's built-in ValidationPipe directly, not a CustomValidationPipe
  - The shared pipe is exported from infrastructure-shared via the pipes index
  - Replacing the built-in pipe is straightforward - just swap the import and factory call
---
## [2026-02-04] - US-003
- Registered shared DtoValidationPipe globally in resume-parser-svc
- Used APP_PIPE provider token in app.module.ts (microservice pattern)
- Added import for createDtoValidationPipe from infrastructure-shared
- Files changed:
  - `apps/resume-parser-svc/src/app/app.module.ts` (updated)
- **Learnings for future iterations:**
  - Pattern: Microservices use APP_PIPE provider token in app.module.ts, whereas HTTP gateways use app.useGlobalPipes() in main.ts
  - The infrastructure-shared library exports both createDtoValidationPipe and its types
  - Import APP_PIPE alongside APP_FILTER and APP_INTERCEPTOR from @nestjs/core
  - Use useFactory with createDtoValidationPipe() for clean instantiation
---
## [2026-02-04] - US-004
- Created shared API error response DTO in libs/shared-dtos
- Defined interfaces: ErrorResponse, ErrorResponseContext, ErrorCorrelation, ErrorRecovery, ErrorImpact, ErrorMonitoring
- Exported ErrorResponseDto and MinimalErrorResponseDto from shared-dtos index
- Files changed:
  - `libs/shared-dtos/src/error-response.dto.ts` (new)
  - `libs/shared-dtos/src/index.ts` (updated)
- **Learnings for future iterations:**
  - Naming conflict: `ErrorContext` is already used as a decorator in error-handling.decorators.ts, so renamed to `ErrorResponseContext`
  - The existing `StandardizedErrorResponse` in error-response-formatter.ts has similar structure - this DTO provides the canonical typed interface
  - Pattern: DTO files should be at the lib root (e.g., error-response.dto.ts) for discoverability, then grouped in subfolders in later refactor stories (US-015/US-016)
---
## [2026-02-04] - US-005
- Aligned error-response-formatter.ts to use shared ErrorResponseDto from error-response.dto.ts
- Deprecated StandardizedErrorResponse interface as an alias to ErrorResponseDto
- Imported and re-exported all related types from error-response.dto.ts
- Updated formatEnhanced method to return ErrorResponseDto type
- Files changed:
  - `libs/shared-dtos/src/errors/error-response-formatter.ts` (updated)
  - `scripts/ralph/prd.json` (updated)
  - `scripts/ralph/progress.txt` (updated)
- **Learnings for future iterations:**
  - The global-exception.filter.ts in app-gateway re-exports from shared-dtos, so updating error-response-formatter.ts automatically propagates the changes
  - Pattern: When consolidating types, use type alias with @deprecated comment for backward compatibility (e.g., `export type StandardizedErrorResponse = ErrorResponseDto`)
  - This allows gradual migration while maintaining existing code that uses the old type name
---
## [2026-02-04] - US-006, US-007
- Audited all NATS services for BaseMicroserviceService usage
- Created docs/NATS_BASE_CLASS_AUDIT.md with comprehensive audit results
- Found all 4 NATS services already extend BaseMicroserviceService (resume-parser-svc, jd-extractor-svc, scoring-engine-svc, report-generator-svc)
- Marked US-007 as passing since no refactoring is needed
- Files changed:
  - `docs/NATS_BASE_CLASS_AUDIT.md` (new)
  - `scripts/ralph/prd.json` (updated)
- **Learnings for future iterations:**
  - All NATS services follow the same pattern: extend BaseMicroserviceService, inject ConfigService/NatsConnectionManager/NatsStreamManager
  - Each service uses protected methods: publishEvent(), publishErrorEvent(), subscribeToEvents()
  - Service names are passed as string to super() constructor: 'resume-parser-svc', 'jd-extractor-svc', 'scoring-engine-svc', 'report-generator-svc'
  - NATS service files are located in apps/{service}/src/services/{service}-nats.service.ts
---
## [2026-02-04] - US-008
- Expanded appGateway schema in libs/configuration with all env vars used by the service
- Updated main.ts to use validateEnv('appGateway') for type-safe config access
- Added getNodeEnv() helper in app.module.ts for centralized environment access
- Replaced direct process.env usage in main.ts bootstrap logic with env validator methods
- Files changed:
  - `libs/configuration/src/env-validator/env-validator.util.ts` (updated)
  - `apps/app-gateway/src/main.ts` (updated)
  - `apps/app-gateway/src/app/app.module.ts` (updated)
- **Learnings for future iterations:**
  - Pattern: validateEnv() returns EnvAccess with methods like getString(), getNumber(), getBoolean(), getArray()
  - Module-level config (before NestJS bootstrap) still needs process.env for NODE_ENV detection
  - Add all env vars to ServiceSchemas to enable type-safe access via the validator
  - Module-level isTestEnv checks use a helper function instead of direct process.env access
  - validateEnv() throws if required env vars are missing - enforces fail-fast architecture
---
## [2026-02-04] - US-009
- Expanded resumeParser schema with MongoDB URL aliases and other env vars
- Added getMongoUrl() helper in app.module.ts for centralized environment access
- Replaced inline process.env fallback chain with helper function
- Files changed:
  - `libs/configuration/src/env-validator/env-validator.util.ts` (updated)
  - `apps/resume-parser-svc/src/app/app.module.ts` (updated)
- **Learnings for future iterations:**
  - MongoDB URL has multiple aliases: MONGODB_URL, MONGO_URL, MONGODB_URI (for test compatibility)
  - Microservices use helper functions at module level since they don't have a main.ts bootstrap
  - Helper function pattern (getMongoUrl) centralizes env access and maintains fail-fast behavior
  - Keep test env vars (USE_DOCKER, JEST_FORCE_EXIT) in schema for documentation even if not used in main code
---
## [2026-02-04] - US-010
- Created docs/REFACTOR_CHECKLIST.md with comprehensive refactoring checklist
- Included pre-refactor, during refactor, and verification steps
- Added quick reference for project commands and common patterns
- Files changed:
  - `docs/REFACTOR_CHECKLIST.md` (new)
- **Learnings for future iterations:**
  - Checklist emphasizes TDD: write tests first, then refactor
  - Verification includes: typecheck, lint, test, build, e2e, contracts
  - Links to key documentation files (CLAUDE.md, progress.txt, NATS audit)
  - Reminds about fail-fast architecture and ESM compatibility
---
## [2026-02-04] - US-011
- Consolidated Jest setup files to use shared jest.setup.ts from jest.preset.cjs
- Moved instanceof matcher patch from jd-extractor-svc/jest.setup.ts to shared jest.setup.ts
- Removed jd-extractor-svc/jest.setup.ts override, now uses shared setup via jest.preset.cjs
- Simplified resume-parser-svc/jest.setup.ts to only contain service-specific mocks (pdf-parse-fork, shared-dtos)
- Removed unused setup-jest.ts file (no references in codebase)
- Files changed:
  - `jest.setup.ts` (updated - added instanceof matcher patch)
  - `apps/jd-extractor-svc/jest.config.ts` (updated - removed setupFilesAfterEnv override)
  - `apps/jd-extractor-svc/jest.setup.ts` (deleted)
  - `apps/resume-parser-svc/jest.setup.ts` (simplified - service-specific mocks only)
  - `setup-jest.ts` (deleted - unused)
- **Learnings for future iterations:**
  - Jest preset pattern: jest.preset.cjs specifies `setupFilesAfterEnv: ['<rootDir>/../../jest.setup.ts']` for shared setup
  - Individual apps can override by specifying their own `setupFilesAfterEnv` in jest.config.ts (REPLACES, not extends)
  - Service-specific mocks (like pdf-parse-fork for resume-parser-svc) should stay in service-level jest.setup.ts
  - The shared jest.setup.ts now includes: cleanup registry, NestJS logger silencing, process warning filtering, handle detection, instanceof matcher patch
  - Test results: jd-extractor-svc (131 passed), resume-parser-svc (153 passed, 2 pre-existing failures)
---
## [2026-02-04] - US-012
- Verified all config folder references use correct /config paths
- Searched docs/ and scripts/ for stale paths to docker-compose.yml, railway.json, render.yaml
- Found all references already correct:
  - config/docker/docker-compose.yml
  - config/docker/.dockerignore
  - config/deployment/railway.json
  - config/deployment/render.yaml
- No file changes needed - verification only
- Files changed:
  - `scripts/ralph/prd.json` (updated)
- **Learnings for future iterations:**
  - The codebase already follows proper config folder organization
  - All documentation correctly references /config/docker/ and /config/deployment/
  - No stale paths found in docs or scripts
  - Verification tasks are important to confirm existing standards before making unnecessary changes
---
