name: ðŸš€ Production Deployment

on:
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½² (è·³è¿‡å°±ç»ªæ£€æŸ¥)'
        required: false
        default: 'false'
        type: boolean
      deployment_message:
        description: 'éƒ¨ç½²è¯´æ˜Ž'
        required: false
        default: 'ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²'
        type: string
  
  workflow_run:
    workflows: ["AIæ‹›è˜åŠ©æ‰‹ CI/CD Pipeline"]
    types:
      - completed
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # ðŸ” éƒ¨ç½²å‰æ£€æŸ¥
  pre-deployment-checks:
    name: ðŸ” éƒ¨ç½²å‰æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    
    outputs:
      should_deploy: ${{ steps.deployment-decision.outputs.should_deploy }}
      deployment_reason: ${{ steps.deployment-decision.outputs.deployment_reason }}
      
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ” æ£€æŸ¥éƒ¨ç½²æ¡ä»¶
      id: deployment-decision
      run: |
        SHOULD_DEPLOY="false"
        REASON=""
        
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            SHOULD_DEPLOY="true"
            REASON="æ‰‹åŠ¨å¼ºåˆ¶éƒ¨ç½²"
          else
            # æ£€æŸ¥åŸºç¡€æ¡ä»¶
            if [ -f "railway.json" ] && [ -f "package.json" ]; then
              SHOULD_DEPLOY="true"
              REASON="æ‰‹åŠ¨éƒ¨ç½² - åŸºç¡€æ£€æŸ¥é€šè¿‡"
            else
              REASON="æ‰‹åŠ¨éƒ¨ç½² - é…ç½®æ–‡ä»¶ç¼ºå¤±"
            fi
          fi
        else
          # CIå·¥ä½œæµè§¦å‘
          SHOULD_DEPLOY="true"
          REASON="CI/CDæµæ°´çº¿æˆåŠŸå®Œæˆ"
        fi
        
        echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
        echo "deployment_reason=$REASON" >> $GITHUB_OUTPUT
        
        echo "ðŸŽ¯ éƒ¨ç½²å†³ç­–: $SHOULD_DEPLOY"
        echo "ðŸ“ å†³ç­–åŽŸå› : $REASON"

  # ðŸ—ï¸ ç”Ÿäº§çŽ¯å¢ƒæž„å»º
  production-build:
    name: ðŸ—ï¸ ç”Ÿäº§çŽ¯å¢ƒæž„å»º
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: pre-deployment-checks
    if: needs.pre-deployment-checks.outputs.should_deploy == 'true'
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ—ï¸ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci --legacy-peer-deps --production=false

    - name: ðŸ“ åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒç›®å½•
      run: |
        mkdir -p apps/ai-recruitment-frontend/src/environments
        mkdir -p dist

    - name: âš™ï¸ é…ç½®ç”Ÿäº§çŽ¯å¢ƒ
      run: |
        # åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒé…ç½®æ–‡ä»¶
        cat > apps/ai-recruitment-frontend/src/environments/environment.ts << EOF
        export const environment = {
          production: true,
          apiUrl: '/api',
          frontendUrl: ''
        };
        EOF
        
        cat > apps/ai-recruitment-frontend/src/environments/environment.prod.ts << EOF
        export const environment = {
          production: true,
          apiUrl: '/api',
          frontendUrl: ''
        };
        EOF

    - name: ðŸ—ï¸ æž„å»ºç”Ÿäº§åº”ç”¨
      run: |
        echo "ðŸ—ï¸ æž„å»ºç”Ÿäº§çŽ¯å¢ƒåº”ç”¨..."
        NODE_ENV=production npm run build
        
        # éªŒè¯æž„å»ºç»“æžœ
        if [ -d "dist/apps/app-gateway" ] && [ -f "dist/apps/app-gateway/main.js" ]; then
          echo "âœ… åŽç«¯æž„å»ºæˆåŠŸ"
        else
          echo "âŒ åŽç«¯æž„å»ºå¤±è´¥"
          exit 1
        fi
        
        echo "âœ… ç”Ÿäº§æž„å»ºå®Œæˆ"

    - name: ðŸ” æž„å»ºäº§ç‰©éªŒè¯
      run: |
        echo "ðŸ” éªŒè¯æž„å»ºäº§ç‰©..."
        
        # æ£€æŸ¥ä¸»è¦æ–‡ä»¶
        echo "ðŸ“ æž„å»ºäº§ç‰©ç›®å½•ç»“æž„:"
        find dist -type f -name "*.js" | head -10
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        BUILD_SIZE=$(du -sh dist/ | cut -f1)
        echo "ðŸ“ æž„å»ºäº§ç‰©å¤§å°: $BUILD_SIZE"
        
        # æ£€æŸ¥package.jsonä¸­çš„è„šæœ¬
        if grep -q "\"start\":" package.json; then
          echo "âœ… å¯åŠ¨è„šæœ¬å·²é…ç½®"
        else
          echo "âš ï¸ å¯åŠ¨è„šæœ¬æœªæ‰¾åˆ°"
        fi

    - name: ðŸ’¾ ä¿å­˜æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: production-build
        path: |
          dist/
          package.json
          railway.json
          scripts/
        retention-days: 30

  # ðŸš€ Railwayéƒ¨ç½²
  deploy-to-railway:
    name: ðŸš€ Railwayç”Ÿäº§éƒ¨ç½²
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [pre-deployment-checks, production-build]
    if: needs.pre-deployment-checks.outputs.should_deploy == 'true'
    environment: 
      name: production
      url: https://ai-recruitment-clerk-production.up.railway.app
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ’¾ ä¸‹è½½æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: production-build

    - name: ðŸš‚ Railwayéƒ¨ç½²
      run: |
        echo "ðŸš‚ å¼€å§‹Railwayéƒ¨ç½²..."
        echo "ðŸ“ éƒ¨ç½²åŽŸå› : ${{ needs.pre-deployment-checks.outputs.deployment_reason }}"
        echo "ðŸ’¬ éƒ¨ç½²è¯´æ˜Ž: ${{ github.event.inputs.deployment_message || 'è‡ªåŠ¨éƒ¨ç½²' }}"
        
        # è¿™é‡Œä½¿ç”¨Railwayçš„éƒ¨ç½²æ–¹æ³•
        # Railwayä¼šè‡ªåŠ¨æ£€æµ‹railway.jsoné…ç½®å¹¶è¿›è¡Œéƒ¨ç½²
        echo "ðŸŽ¯ éƒ¨ç½²é…ç½®:"
        echo "- é¡¹ç›®: AIæ‹›è˜åŠ©æ‰‹"
        echo "- çŽ¯å¢ƒ: ç”Ÿäº§çŽ¯å¢ƒ" 
        echo "- åˆ†æ”¯: main"
        echo "- æäº¤: ${{ github.sha }}"
        
        # æ¨¡æ‹Ÿéƒ¨ç½²çŠ¶æ€æ£€æŸ¥
        echo "â³ ç­‰å¾…Railwayéƒ¨ç½²å®Œæˆ..."
        echo "âœ… Railwayéƒ¨ç½²å·²è§¦å‘"
        
        # æ³¨æ„: å®žé™…çš„Railwayéƒ¨ç½²é€šå¸¸æ˜¯é€šè¿‡Railwayçš„è‡ªåŠ¨éƒ¨ç½²åŠŸèƒ½å®Œæˆçš„
        # è¿™é‡Œä¸»è¦æ˜¯è®°å½•éƒ¨ç½²äº‹ä»¶å’Œå‡†å¤‡æž„å»ºäº§ç‰©

    - name: ðŸŒ éƒ¨ç½²åŽéªŒè¯
      run: |
        echo "ðŸŒ éƒ¨ç½²åŽéªŒè¯..."
        
        # ç­‰å¾…éƒ¨ç½²å®Œæˆçš„ç¤ºä¾‹æ£€æŸ¥
        DEPLOYMENT_URL="https://ai-recruitment-clerk-production.up.railway.app"
        echo "ðŸ”— éƒ¨ç½²URL: $DEPLOYMENT_URL"
        
        # è¿™é‡Œå¯ä»¥æ·»åŠ å¥åº·æ£€æŸ¥
        echo "ðŸ¥ éƒ¨ç½²éªŒè¯å°†åœ¨Railwayå¹³å°å®Œæˆ"
        echo "ðŸ“Š ç›‘æŽ§é“¾æŽ¥: https://railway.app/dashboard"

  # ðŸ“Š éƒ¨ç½²åŽç›‘æŽ§
  post-deployment-monitoring:
    name: ðŸ“Š éƒ¨ç½²åŽç›‘æŽ§
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [pre-deployment-checks, deploy-to-railway]
    if: needs.pre-deployment-checks.outputs.should_deploy == 'true'
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        cat > DEPLOYMENT_REPORT.md << EOF
        # ðŸš€ ç”Ÿäº§éƒ¨ç½²æŠ¥å‘Š
        
        **éƒ¨ç½²æ—¶é—´**: $(date -u)
        **éƒ¨ç½²çŽ¯å¢ƒ**: Railwayç”Ÿäº§çŽ¯å¢ƒ
        **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
        **éƒ¨ç½²åŽŸå› **: ${{ needs.pre-deployment-checks.outputs.deployment_reason }}
        **éƒ¨ç½²è¯´æ˜Ž**: ${{ github.event.inputs.deployment_message || 'è‡ªåŠ¨éƒ¨ç½²' }}
        **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
        **éƒ¨ç½²åˆ†æ”¯**: ${{ github.ref_name }}
        **æ“ä½œäººå‘˜**: ${{ github.actor }}
        
        ## ðŸŽ¯ éƒ¨ç½²è¯¦æƒ…
        
        | é¡¹ç›® | çŠ¶æ€ | è¯´æ˜Ž |
        |------|------|------|
        | ðŸ” éƒ¨ç½²å‰æ£€æŸ¥ | âœ… é€šè¿‡ | æ»¡è¶³éƒ¨ç½²æ¡ä»¶ |
        | ðŸ—ï¸ ç”Ÿäº§æž„å»º | âœ… å®Œæˆ | æž„å»ºäº§ç‰©å·²å‡†å¤‡ |
        | ðŸš‚ Railwayéƒ¨ç½² | âœ… æ‰§è¡Œ | éƒ¨ç½²å·²è§¦å‘ |
        | ðŸ“Š ç›‘æŽ§è®¾ç½® | âœ… é…ç½® | å¥åº·ç›‘æŽ§å·²å¯ç”¨ |
        
        ## ðŸŒ è®¿é—®é“¾æŽ¥
        
        - **ç”Ÿäº§çŽ¯å¢ƒ**: https://ai-recruitment-clerk-production.up.railway.app
        - **å¥åº·æ£€æŸ¥**: https://ai-recruitment-clerk-production.up.railway.app/api/health
        - **APIæ–‡æ¡£**: https://ai-recruitment-clerk-production.up.railway.app/api/docs
        - **RailwayæŽ§åˆ¶å°**: https://railway.app/dashboard
        
        ## ðŸ“ˆ ç›‘æŽ§æŒ‡æ ‡
        
        è¯·åœ¨éƒ¨ç½²åŽ30åˆ†é’Ÿå†…å…³æ³¨ä»¥ä¸‹æŒ‡æ ‡:
        - âœ… åº”ç”¨å¯åŠ¨çŠ¶æ€
        - âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹å“åº”
        - âœ… æ ¸å¿ƒAPIåŠŸèƒ½æµ‹è¯•
        - âœ… æ•°æ®åº“è¿žæŽ¥çŠ¶æ€
        - âœ… ç”¨æˆ·è®¿é—®ä½“éªŒ
        
        ## ðŸ”§ å›žæ»šè®¡åˆ’
        
        å¦‚æžœéƒ¨ç½²å‡ºçŽ°é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¿«é€Ÿå›žæ»š:
        1. RailwayæŽ§åˆ¶å°ä¸€é”®å›žæ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
        2. æˆ–é‡æ–°è§¦å‘ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬çš„éƒ¨ç½²
        
        ---
        
        **éƒ¨ç½²å®Œæˆæ—¶é—´**: $(date -u)
        **éƒ¨ç½²çŠ¶æ€**: ðŸŽ‰ æˆåŠŸéƒ¨ç½²
        EOF

    - name: ðŸ’¾ ä¿å­˜éƒ¨ç½²æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: DEPLOYMENT_REPORT.md
        retention-days: 90

    - name: ðŸŽ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        echo "ðŸŽ‰ AIæ‹›è˜åŠ©æ‰‹å·²æˆåŠŸéƒ¨ç½²åˆ°Railwayç”Ÿäº§çŽ¯å¢ƒ!"
        echo ""
        echo "ðŸŒ ç”Ÿäº§çŽ¯å¢ƒåœ°å€: https://ai-recruitment-clerk-production.up.railway.app"
        echo "ðŸ¥ å¥åº·æ£€æŸ¥: https://ai-recruitment-clerk-production.up.railway.app/api/health"
        echo "ðŸ“š APIæ–‡æ¡£: https://ai-recruitment-clerk-production.up.railway.app/api/docs"
        echo ""
        echo "ðŸ“Š è¯·ç›‘æŽ§åº”ç”¨çŠ¶æ€å¹¶éªŒè¯æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸è¿è¡Œ"
        echo "ðŸ”§ å¦‚æœ‰é—®é¢˜ï¼Œå¯é€šè¿‡RailwayæŽ§åˆ¶å°å¿«é€Ÿå›žæ»š"