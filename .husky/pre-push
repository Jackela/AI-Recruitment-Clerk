#!/usr/bin/env sh
set -e

# Skip local CI for delete-only pushes.
delete_only=1
while read -r local_ref local_ref local_sha remote_sha; do
  if [ "$local_ref" != "0000000000000000000000000000000000000000" ]; then
    delete_only=0
    break
  fi
done

if [ "$delete_only" -eq 1 ]; then
  echo "â­ï¸  Skipping ci:local for delete-only push"
  exit 0
fi

echo "ğŸš€ Running STRICT pre-push CI checks..."
echo "â±ï¸  This will test ALL projects. May take 10-15 minutes."
echo ""

# Start time
START_TIME=$(date +%s)

# 1. Lint all
echo "ğŸ“‹ Step 1/6: Linting ALL projects..."
npm run lint
echo "âœ… Lint passed"
echo ""

# 2. Typecheck all
echo "ğŸ” Step 2/6: Type-checking ALL projects..."
npm run typecheck
echo "âœ… Typecheck passed"
echo ""

# 3. All unit tests with coverage
echo "ğŸ§ª Step 3/6: Running ALL unit tests with coverage..."
npm run test:coverage
echo "âœ… Tests passed"
echo ""

# 4. Build all (including frontend for E2E)
echo "ğŸ”¨ Step 4/6: Building ALL projects..."
npm run build

# Build frontend specifically for E2E
echo "ğŸ“¦ Building frontend for E2E..."
npx nx run ai-recruitment-frontend:build:production
echo "âœ… Build passed"
echo ""

# 5. Start static server for E2E in background
echo "ğŸŒ Starting static server for E2E..."
npx serve dist/apps/ai-recruitment-frontend/browser -l 4200 -s > /tmp/e2e-server.log 2>&1 &
SERVER_PID=$!
echo "Server started with PID: $SERVER_PID"

# Wait for server to be ready
echo "Waiting for server to be ready..."
for i in $(seq 1 30); do
  if curl -s http://localhost:4200 > /dev/null 2>&1; then
    echo "âœ… Server is ready!"
    break
  fi
  if [ $i -eq 30 ]; then
    echo "âŒ Server failed to start"
    cat /tmp/e2e-server.log
    kill $SERVER_PID 2>/dev/null
    exit 1
  fi
  sleep 1
done

# 6. E2E tests - MUST PASS
# Skip slow PDF tests that require backend API (@pdf-variety, @real-data tags)
echo "ğŸ­ Step 5/6: Running E2E tests (skipping slow PDF integration tests)..."
export CI=true
export E2E_SKIP_WEBSERVER=true
export PLAYWRIGHT_BASE_URL=http://localhost:4200
cd apps/ai-recruitment-frontend-e2e && npx playwright test --grep-invert "@pdf-variety\|@real-data"
E2E_EXIT_CODE=$?

# Stop the server
echo "Stopping server..."
kill $SERVER_PID 2>/dev/null || true
wait $SERVER_PID 2>/dev/null || true

if [ $E2E_EXIT_CODE -ne 0 ]; then
  echo "âŒ E2E tests failed"
  exit 1
fi
echo "âœ… E2E tests passed"
echo ""

# 7. CodeQL analysis - MUST PASS
echo "ğŸ”’ Step 6/6: Running CodeQL security analysis..."
if command -v codeql >/dev/null 2>&1; then
  # Create a database for TypeScript/JavaScript analysis
  echo "Creating CodeQL database..."
  rm -rf .codeql-db
  codeql database create --language=javascript --overwrite --command="npm run build" .codeql-db || {
    echo "âš ï¸  CodeQL database creation failed, continuing..."
  }

  # Run security queries - check for errors but don't fail on warnings
  if [ -d .codeql-db ]; then
    echo "Analyzing with CodeQL security queries..."
    codeql database analyze .codeql-db --format=sarif-latest --output=codeql-results.sarif \
      javascript-security-and-quality.qls || {
      echo "âš ï¸  CodeQL analysis had issues, but continuing..."
    }
    echo "âœ… CodeQL analysis complete"
  fi
else
  echo "âš ï¸  CodeQL CLI not found - skipping security analysis"
  echo "   Install with: npm install -g @codeql/cli"
fi
echo ""

# Calculate elapsed time
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))
MINUTES=$((ELAPSED / 60))
SECONDS=$((ELAPSED % 60))

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ALL STRICT pre-push checks passed!"
echo "â±ï¸  Total time: ${MINUTES}m ${SECONDS}s"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
