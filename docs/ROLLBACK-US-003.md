# Rollback Plan: US-003 - Fix dependency gate inventory for semantic release

## Change Summary
Verified that the dependency gate inventory is stable and the gate evaluation is deterministic. The inventory file is generated by `npm audit` in the CI workflow before running the gate script.

## Current State
- `data/security/dependency-inventory.json` exists and contains current audit data
- `scripts/dependency-gate.mjs` runs successfully
- CI workflow `.github/workflows/release.yml` generates inventory before running gate
- Gate outputs summary to `data/security/release-gate-summary.json`
- Current status: 0 vulnerabilities (all clear)

## How It Works

### CI Workflow Steps (release.yml)
1. **Generate inventory**: `npm audit --json > data/security/dependency-inventory.json`
2. **Run gate**: `node scripts/dependency-gate.mjs`
3. **Evaluate**: Blocks release if critical/high/moderate vulnerabilities found

### Gate Evaluation Logic
- **Blocks** if: `critical > 0 OR high > 0 OR moderate > 0`
- **Clear** if: All vulnerability counts are 0
- Reads optional remediation doc: `docs/security/dependency-remediation.md`
- Outputs: `data/security/release-gate-summary.json` with status, totals, findings

## Rollback Procedure

If dependency gate causes CI failures or blocking issues:

### Option 1: Make gate non-blocking (Quick fix)
Edit `.github/workflows/release.yml` line 42-47:
```yaml
- name: üîê Enforce dependency gate
  continue-on-error: true  # Add this line
  run: |
    echo "üîê Generating dependency inventory..."
    npm audit --audit-level=moderate --json > data/security/dependency-inventory.json || true
    echo "üöß Evaluating release gate..."
    node scripts/dependency-gate.mjs || true  # Add || true
```

### Option 2: Adjust severity threshold
Edit `scripts/dependency-gate.mjs` line 115:
```javascript
// Original: Blocks on critical, high, moderate
const status =
  totals.critical > 0 || totals.high > 0 || totals.moderate > 0 ? 'blocked' : 'clear';

// Changed to: Only block on critical, high
const status =
  totals.critical > 0 || totals.high > 0 ? 'blocked' : 'clear';
```

### Option 3: Temporarily disable gate
Edit `.github/workflows/release.yml`:
```yaml
- name: üîê Enforce dependency gate
  run: |
    echo "‚ö†Ô∏è Dependency gate temporarily disabled"
    # npm audit --audit-level=moderate --json > data/security/dependency-inventory.json || true
    # node scripts/dependency-gate.mjs
```

### Option 4: Allow specific vulnerabilities
1. Create or edit `docs/security/dependency-remediation.md`
2. Add remediation decisions with owner assignments:
   ```markdown
   ## Remediation Decisions
   - `package-name@1.2.3` - Owner: @username - Reason: False positive, under review
   - `ADVISORY-ID` - Owner: @team - Reason: Accepted risk, no production impact
   ```
3. Gate will still show as blocked but ownership is tracked

### Option 5: Skip inventory generation
```yaml
# Use pre-generated inventory or skip gate entirely
- name: üîê Enforce dependency gate
  run: echo "Using pre-existing inventory"
```

## Verification After Rollback
- [ ] `node scripts/dependency-gate.mjs` runs without errors
- [ ] CI release workflow completes
- [ ] Gate summary file is generated: `data/security/release-gate-summary.json`
- [ ] No blocking errors in release job

## Risk Assessment
- **Risk Level**: Low
- **Impact**: Blocks releases only if vulnerabilities found
- **Detection**: CI release job will fail
- **Recovery Time**: < 5 minutes for any option
- **Side Effects**: None - gate only affects releases, not development

## Important Notes
- **Inventory is generated in CI** by `npm audit` command
- **Not a static file** - it's regenerated on each run
- **No manual updates needed** - `npm audit` always produces current data
- **Deterministic** - same npm lockfile produces same audit results
- **Exit code 1** means blocked, exit code 0 means clear
- **Summary file** is created regardless of pass/fail for visibility

## Regenerating Inventory Manually
```bash
# Generate fresh inventory
npm audit --audit-level=moderate --json > data/security/dependency-inventory.json

# Run gate manually
node scripts/dependency-gate.mjs

# Check result
cat data/security/release-gate-summary.json
```

## Related Files
- `scripts/dependency-gate.mjs` - Gate evaluation script
- `data/security/dependency-inventory.json` - Generated by npm audit (auto-regenerated)
- `data/security/release-gate-summary.json` - Gate output (auto-generated)
- `.github/workflows/release.yml` - CI workflow that runs the gate
- `docs/security/dependency-remediation.md` - Optional remediation decisions
